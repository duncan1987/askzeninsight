# é€€æ¬¾é€»è¾‘å®Œæ•´æ£€æŸ¥æ¸…å•

## ğŸ“‹ ä¸‰ç§åœºæ™¯çš„é¢„æœŸè¡Œä¸º

### åœºæ™¯1: 48å°æ—¶å†…å–æ¶ˆ

**æ—¶é—´**: â‰¤ 48å°æ—¶

**å¤„ç†é€»è¾‘**:
```
âœ… ç«‹å³åœ¨Creemå–æ¶ˆè®¢é˜…
âœ… ç«‹å³è®¾ç½® subscription.status = 'cancelled'
âœ… ç«‹å³é™çº§åˆ°Free tier
âœ… è®¡ç®—å¹¶æ˜¾ç¤ºé€€æ¬¾é‡‘é¢
âœ… å‘é€"ç«‹å³å–æ¶ˆ"é‚®ä»¶
```

**ç”¨æˆ·çœ‹åˆ°**:
- Alert: "è®¢é˜…å·²å–æ¶ˆï¼Œä½ ç°åœ¨æ˜¯Freeç”¨æˆ·"
- Dashboard: æ˜¾ç¤ºFree tierç”¨é‡ (10æ¡/å¤©)
- UsageMeter: "10 / 10 messages"
- Chatç•Œé¢: "Free â€¢ glm-4-flash"

**refund_status**: `'requested'` (ä½†æœ‰status='cancelled'è¦†ç›–)

---

### åœºæ™¯2: 48å°æ—¶ - 7å¤©å–æ¶ˆ

**æ—¶é—´**: 48h < æ—¶é—´ â‰¤ 7å¤©

**å¤„ç†é€»è¾‘**:
```
âŒ ä¸åœ¨Creemå–æ¶ˆè®¢é˜…
âŒ ä¸ä¿®æ”¹ subscription.status (ä¿æŒ 'active')
âœ… è®¾ç½® refund_status = 'requested'
âœ… è®¡ç®—å¹¶ä¿å­˜é¢„ä¼°é€€æ¬¾é‡‘é¢ (refund_amount)
âœ… è®°å½•é€€æ¬¾è®¡ç®—æ—¶é—´ (refund_estimated_at)
âœ… ä¿æŒProæƒé™ï¼ˆ3å¤©å®¡æ ¸æœŸï¼‰
âœ… å‘é€"å®¡æ ¸ä¸­"é‚®ä»¶
```

**ç”¨æˆ·çœ‹åˆ°**:
- Alert: "âœ… ä½ çš„Proè®¿é—®æƒé™åœ¨å®¡æ ¸æœŸé—´ä¿æŒæ¿€æ´»"
- Dashboard: **ä»ç„¶æ˜¾ç¤ºPro tierç”¨é‡ (30æ¡/å¤©)** âš ï¸ è¿™é‡Œå¯èƒ½æœ‰é—®é¢˜
- UsageMeter: "X / 30 messages"
- Chatç•Œé¢: "Pro â€¢ glm-4.7"

**refund_status**: `'requested'`
**subscription.status**: `'active'` (ä¸å˜)

---

### åœºæ™¯3: è¶…è¿‡7å¤©

**æ—¶é—´**: > 7å¤©

**å¤„ç†é€»è¾‘**:
```
âŒ é˜»æ­¢å–æ¶ˆ
âŒ è¿”å›403é”™è¯¯
âœ… æç¤ºè”ç³»å®¢æœ
```

**ç”¨æˆ·çœ‹åˆ°**:
- Alert: "å–æ¶ˆæœŸå·²è¿‡ï¼Œè¯·è®¿é—®é€€æ¬¾æ”¿ç­–é¡µé¢"
- ä¿æŒå½“å‰çŠ¶æ€ï¼ˆPro tierï¼‰

---

## ğŸ” éœ€è¦æ£€æŸ¥çš„å…³é”®ç‚¹

### 1. subscription.ts æŸ¥è¯¢å­—æ®µ
- [x] å·²ä¿®å¤ï¼šæ”¹ä¸º `select('*')`
- ç¡®ä¿åŒ…å«ï¼š`refund_status`, `refund_estimated_at`, `refund_amount`

### 2. å–æ¶ˆAPIé€»è¾‘ (app/api/subscription/cancel/route.ts)
- [x] 48hå†…ï¼š`immediateCancellation=true`
- [x] 48h-7å¤©ï¼š`immediateCancellation=false`, `keepProAccess=true`
- [x] è®¾ç½®refundç›¸å…³å­—æ®µ

### 3. subscription.ts isProåˆ¤æ–­
- [x] éœ€è¦æ£€æŸ¥ï¼š`refund_status='requested'` æ—¶æ˜¯å¦è¿”å›Pro

### 4. subscription-status-cardç»„ä»¶
- [ ] éœ€è¦ä¿®å¤ï¼šæ˜¾ç¤ºrefundå®¡æ ¸çŠ¶æ€
- [ ] éœ€è¦æ·»åŠ refund_statusåˆ°æ¥å£

### 5. Dashboardè®¢é˜…æŸ¥è¯¢
- [ ] æŸ¥è¯¢æ¡ä»¶å¯èƒ½éœ€è¦è°ƒæ•´

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•åœºæ™¯1: 48å°æ—¶å†…
1. åˆ›å»ºè®¢é˜…
2. ç«‹å³å–æ¶ˆï¼ˆ48hå†…ï¼‰
3. é¢„æœŸï¼šç«‹å³é™çº§åˆ°Free
4. åˆ·æ–°Dashboard
5. æ£€æŸ¥ï¼šæ˜¾ç¤º "10 / 10 messages" âœ…

### æµ‹è¯•åœºæ™¯2: 48h-7å¤©
1. åˆ›å»ºè®¢é˜…
2. ç­‰å¾…48å°æ—¶
3. å–æ¶ˆè®¢é˜…
4. é¢„æœŸï¼šä¿æŒProæƒé™
5. åˆ·æ–°Dashboard
6. æ£€æŸ¥ï¼š**æ˜¾ç¤º "X / 30 messages"** âš ï¸ å½“å‰é—®é¢˜
7. æ£€æŸ¥subscription.statusåº”è¯¥æ˜¯ 'active'
8. æ£€æŸ¥refund_statusåº”è¯¥æ˜¯ 'requested'

### æµ‹è¯•åœºæ™¯3: >7å¤©
1. å°è¯•å–æ¶ˆ
2. é¢„æœŸï¼š403é”™è¯¯
3. ä¿æŒProçŠ¶æ€

---

## ğŸ› å½“å‰é—®é¢˜åˆ†æ

ç”¨æˆ·æŠ¥å‘Šï¼š"è®¢é˜…è¶…è¿‡48å°æ—¶çš„å–æ¶ˆæç¤ºå¯¹äº†ï¼Œä½†æ˜¯Dashboardé¡µé¢çš„Daily Usageç¡®åˆ·æ–°ä¸ºå…è´¹ç”¨æˆ·çš„ç”¨é‡äº†"

**å¯èƒ½åŸå› **:
1. âŒ æ•°æ®åº“è¿ç§»æœªè¿è¡Œ - refund_statuså­—æ®µä¸å­˜åœ¨
2. âŒ subscriptionæŸ¥è¯¢è¿‡æ»¤æ‰äº†refund_status='requested'çš„è®°å½•
3. âŒ ç¼“å­˜é—®é¢˜
4. âŒ Dashboardçš„è®¢é˜…æŸ¥è¯¢é€»è¾‘é—®é¢˜

**æœ€å¯èƒ½çš„åŸå› **:
- DashboardæŸ¥è¯¢æ—¶å¯èƒ½ä½¿ç”¨äº†ä¸åŒçš„æŸ¥è¯¢é€»è¾‘
- æˆ–è€…subscription.tsçš„æŸ¥è¯¢å­—æ®µä¸å®Œæ•´ï¼ˆå·²ä¿®å¤ï¼‰

---

## ğŸ”§ éœ€è¦ä¿®å¤çš„æ–‡ä»¶

1. âœ… `lib/subscription.ts` - å·²ä¿®å¤selectæŸ¥è¯¢
2. [ ] `components/subscription-status-card.tsx` - éœ€è¦æ˜¾ç¤ºrefundçŠ¶æ€
3. [ ] `app/dashboard/page.tsx` - å¯èƒ½éœ€è¦è°ƒæ•´æŸ¥è¯¢é€»è¾‘
